{"version":3,"sources":["../../src/test/setupExamples.ts"],"sourcesContent":["import {exec as execNode} from 'node:child_process'\nimport {readFile, rm, writeFile} from 'node:fs/promises'\nimport {basename, join} from 'node:path'\nimport {promisify} from 'node:util'\n\nimport ora from 'ora'\nimport {glob} from 'tinyglobby'\nimport {type TestProject} from 'vitest/node'\n\nimport {fileExists} from '../utils/fileExists.js'\nimport {getExamplesPath, getTempPath} from '../utils/paths.js'\nimport {DEFAULT_EXAMPLES} from './constants.js'\nimport {testCopyDirectory} from './testExample.js'\n\nconst exec = promisify(execNode)\n\n/** Options for setupTestExamples */\nexport interface SetupTestExamplesOptions {\n  /**\n   * Glob patterns for additional example directories to set up.\n   *\n   * Each pattern is matched against directories in the current working directory.\n   * Only directories containing a `package.json` file are included.\n   *\n   * @example\n   * ```typescript\n   * ['examples/*', 'dev/*']\n   * ```\n   */\n  additionalExamples?: string[]\n\n  /**\n   * Custom temp directory path. Defaults to process.cwd()/tmp\n   */\n  tempDir?: string\n}\n\nasync function getAdditionalExamplePaths(examples: string[]): Promise<ExamplePath[]> {\n  const paths = await glob(examples, {\n    absolute: true,\n    ignore: ['**/node_modules/**', '**/dist/**'],\n    onlyDirectories: true,\n  })\n\n  const additionalExamples: ExamplePath[] = []\n\n  for (const path of paths) {\n    if (await fileExists(join(`${path}/package.json`))) {\n      additionalExamples.push({\n        example: basename(path),\n        fromPath: path,\n      })\n    }\n  }\n\n  return additionalExamples\n}\n\ninterface ExamplePath {\n  example: string\n  fromPath: string\n}\n/**\n * Global setup function for initializing test examples.\n *\n * Copies examples from the bundled location to a temp directory\n * and installs dependencies.\n *\n * Note: Examples are NOT built during setup. Tests that need built\n * examples should build them as part of the test.\n *\n * This function is designed to be used with vitest globalSetup.\n *\n * @param options - Configuration options\n * @example\n * ```typescript\n * // In vitest.config.ts\n * export default defineConfig({\n *   test: {\n *     globalSetup: ['@sanity/cli-test/vitest']\n *   }\n * })\n * ```\n */\nexport async function setup(_: TestProject, options: SetupTestExamplesOptions = {}): Promise<void> {\n  const {additionalExamples, tempDir} = options\n\n  const spinner = ora({\n    // Without this, the watch mode input is discarded\n    discardStdin: false,\n    text: 'Initializing test environment...',\n  }).start()\n\n  try {\n    const examplesDir = getExamplesPath()\n    const tempDirectory = getTempPath(tempDir)\n\n    const allExamplePaths: ExamplePath[] = []\n\n    // Add the default examples\n    for (const example of DEFAULT_EXAMPLES) {\n      allExamplePaths.push({\n        example,\n        fromPath: join(examplesDir, example),\n      })\n    }\n\n    // Add the additional examples\n    if (additionalExamples && additionalExamples.length > 0) {\n      const additionalExamplePaths = await getAdditionalExamplePaths(additionalExamples)\n\n      if (additionalExamplePaths.length > 0) {\n        allExamplePaths.push(...additionalExamplePaths)\n      } else {\n        spinner.warn(\n          `No additional examples found, check the glob pattern: ${additionalExamples.join(', ')}`,\n        )\n      }\n    }\n\n    for (const {example, fromPath} of allExamplePaths) {\n      const toPath = join(tempDirectory, `example-${example}`)\n      // Copy the example, excluding node_modules and dist\n      await testCopyDirectory(fromPath, toPath, ['node_modules', 'dist'])\n\n      // Replace the package.json name with a temp name\n      const packageJsonPath = join(toPath, 'package.json')\n      const packageJson = await readFile(packageJsonPath, 'utf8')\n      const packageJsonData = JSON.parse(packageJson)\n      packageJsonData.name = `${packageJsonData.name}-test`\n      await writeFile(packageJsonPath, JSON.stringify(packageJsonData, null, 2))\n\n      // Run pnpm install --no-lockfile in the temp directory\n      try {\n        await exec(`pnpm install --prefer-offline --no-lockfile`, {\n          cwd: toPath,\n        })\n      } catch (error) {\n        const execError = error as {message: string; stderr?: string; stdout?: string}\n        spinner.fail('Failed to install dependencies')\n        console.error(execError.stderr || execError.stdout || execError.message)\n        throw new Error(\n          `Error installing dependencies in ${toPath}: ${execError.stderr || execError.stdout || execError.message}`,\n        )\n      }\n    }\n\n    spinner.succeed('Test environment initialized')\n  } catch (error) {\n    spinner.fail('Failed to initialize test environment')\n    throw error\n  }\n}\n\n/** Options for teardownTestExamples */\nexport interface TeardownTestExamplesOptions {\n  /**\n   * Custom temp directory path. Defaults to process.cwd()/tmp\n   */\n  tempDir?: string\n}\n\n/**\n * Teardown function to clean up test examples.\n *\n * Removes the temp directory created by setupTestExamples.\n *\n * This function is designed to be used with vitest globalSetup.\n *\n * @param options - Configuration options\n */\nexport async function teardown(options: TeardownTestExamplesOptions = {}): Promise<void> {\n  const {tempDir} = options\n  const tempDirectory = getTempPath(tempDir)\n\n  // Remove the tmp directory\n  await rm(tempDirectory, {force: true, recursive: true})\n}\n"],"names":["exec","execNode","readFile","rm","writeFile","basename","join","promisify","ora","glob","fileExists","getExamplesPath","getTempPath","DEFAULT_EXAMPLES","testCopyDirectory","getAdditionalExamplePaths","examples","paths","absolute","ignore","onlyDirectories","additionalExamples","path","push","example","fromPath","setup","_","options","tempDir","spinner","discardStdin","text","start","examplesDir","tempDirectory","allExamplePaths","length","additionalExamplePaths","warn","toPath","packageJsonPath","packageJson","packageJsonData","JSON","parse","name","stringify","cwd","error","execError","fail","console","stderr","stdout","message","Error","succeed","teardown","force","recursive"],"mappings":"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"}