{"version":3,"sources":["../../src/test/testExample.ts"],"sourcesContent":["import {randomBytes} from 'node:crypto'\nimport {copyFile, mkdir, readdir, readFile, stat, symlink, writeFile} from 'node:fs/promises'\nimport {join} from 'node:path'\n\nimport {getExamplesPath, getTempPath} from '../utils/paths.js'\nimport {type ExampleName} from './constants.js'\n\n/**\n * Recursively copy a directory, skipping specified folders.\n *\n * @param srcDir - Source directory to copy from\n * @param destDir - Destination directory to copy to\n * @param skip - Array of directory/file names to skip (e.g., ['node_modules', 'dist'])\n * @internal\n */\nexport async function testCopyDirectory(\n  srcDir: string,\n  destDir: string,\n  skip: string[] = [],\n): Promise<void> {\n  await mkdir(destDir, {recursive: true})\n\n  const entries = await readdir(srcDir)\n\n  for (const entry of entries) {\n    if (skip.includes(entry)) {\n      continue\n    }\n\n    const srcPath = join(srcDir, entry)\n    const destPath = join(destDir, entry)\n\n    const stats = await stat(srcPath)\n\n    await (stats.isDirectory()\n      ? testCopyDirectory(srcPath, destPath, skip)\n      : copyFile(srcPath, destPath))\n  }\n}\n\n/** Options for testExample */\nexport interface TestExampleOptions {\n  /**\n   * Custom temp directory. Defaults to process.cwd()/tmp\n   */\n  tempDir?: string\n}\n\n/**\n * Clones an example directory into a temporary directory with an isolated copy.\n *\n * The function creates a unique temporary copy of the specified example with:\n * - A random unique ID to avoid conflicts between parallel tests\n * - Symlinked node_modules for performance (from the global setup version)\n * - Modified package.json name to prevent conflicts\n *\n * The example is first looked up in the temp directory (if global setup ran),\n * otherwise it falls back to the bundled examples in the package.\n *\n * @param exampleName - The name of the example to clone (e.g., 'basic-app', 'basic-studio')\n * @param options - Configuration options\n * @returns The absolute path to the temporary directory containing the example\n *\n * @example\n * ```typescript\n * import {testExample} from '@sanity/cli-test'\n * import {describe, test} from 'vitest'\n *\n * describe('my test suite', () => {\n *   test('should work with basic-studio', async () => {\n *     const cwd = await testExample('basic-studio')\n *     // ... run your tests in this directory\n *   })\n * })\n * ```\n */\nexport async function testExample(\n  exampleName: ExampleName | (string & {}),\n  options: TestExampleOptions = {},\n): Promise<string> {\n  const {tempDir} = options\n\n  const tempDirectory = getTempPath(tempDir)\n\n  // Examples are cloned in the tmp directory by the setup function\n  let tempExamplePath = join(tempDirectory, `example-${exampleName}`)\n\n  try {\n    const stats = await stat(tempExamplePath)\n    if (!stats.isDirectory()) {\n      throw new Error(`${tempExamplePath} is not a directory`)\n    }\n  } catch (e) {\n    // If the cloned example doesn't exist, copy from the bundled examples\n    if ((e as NodeJS.ErrnoException).code === 'ENOENT') {\n      tempExamplePath = join(getExamplesPath(), exampleName)\n    } else {\n      throw e\n    }\n  }\n\n  const tempId = randomBytes(8).toString('hex')\n  const tempPath = join(tempDirectory, `example-${exampleName}-${tempId}`)\n\n  // Always skip node_modules (will be symlinked), dist (tests build if needed), and tmp\n  const skipDirs = ['node_modules', 'dist', 'tmp']\n\n  // Copy the example to the temp directory\n  await testCopyDirectory(tempExamplePath, tempPath, skipDirs)\n\n  // Symlink the node_modules directory for performance\n  await symlink(join(tempExamplePath, 'node_modules'), join(tempPath, 'node_modules'))\n\n  // Replace the package.json name with a temp name\n  const packageJsonPath = join(tempPath, 'package.json')\n  const packageJson = await readFile(packageJsonPath, 'utf8')\n  const packageJsonData = JSON.parse(packageJson)\n  packageJsonData.name = `${packageJsonData.name}-${tempId}`\n  await writeFile(packageJsonPath, JSON.stringify(packageJsonData, null, 2))\n\n  return tempPath\n}\n"],"names":["randomBytes","copyFile","mkdir","readdir","readFile","stat","symlink","writeFile","join","getExamplesPath","getTempPath","testCopyDirectory","srcDir","destDir","skip","recursive","entries","entry","includes","srcPath","destPath","stats","isDirectory","testExample","exampleName","options","tempDir","tempDirectory","tempExamplePath","Error","e","code","tempId","toString","tempPath","skipDirs","packageJsonPath","packageJson","packageJsonData","JSON","parse","name","stringify"],"mappings":"AAAA,SAAQA,WAAW,QAAO,cAAa;AACvC,SAAQC,QAAQ,EAAEC,KAAK,EAAEC,OAAO,EAAEC,QAAQ,EAAEC,IAAI,EAAEC,OAAO,EAAEC,SAAS,QAAO,mBAAkB;AAC7F,SAAQC,IAAI,QAAO,YAAW;AAE9B,SAAQC,eAAe,EAAEC,WAAW,QAAO,oBAAmB;AAG9D;;;;;;;CAOC,GACD,OAAO,eAAeC,kBACpBC,MAAc,EACdC,OAAe,EACfC,OAAiB,EAAE;IAEnB,MAAMZ,MAAMW,SAAS;QAACE,WAAW;IAAI;IAErC,MAAMC,UAAU,MAAMb,QAAQS;IAE9B,KAAK,MAAMK,SAASD,QAAS;QAC3B,IAAIF,KAAKI,QAAQ,CAACD,QAAQ;YACxB;QACF;QAEA,MAAME,UAAUX,KAAKI,QAAQK;QAC7B,MAAMG,WAAWZ,KAAKK,SAASI;QAE/B,MAAMI,QAAQ,MAAMhB,KAAKc;QAEzB,MAAOE,CAAAA,MAAMC,WAAW,KACpBX,kBAAkBQ,SAASC,UAAUN,QACrCb,SAASkB,SAASC,SAAQ;IAChC;AACF;AAUA;;;;;;;;;;;;;;;;;;;;;;;;;;;CA2BC,GACD,OAAO,eAAeG,YACpBC,WAAwC,EACxCC,UAA8B,CAAC,CAAC;IAEhC,MAAM,EAACC,OAAO,EAAC,GAAGD;IAElB,MAAME,gBAAgBjB,YAAYgB;IAElC,iEAAiE;IACjE,IAAIE,kBAAkBpB,KAAKmB,eAAe,CAAC,QAAQ,EAAEH,aAAa;IAElE,IAAI;QACF,MAAMH,QAAQ,MAAMhB,KAAKuB;QACzB,IAAI,CAACP,MAAMC,WAAW,IAAI;YACxB,MAAM,IAAIO,MAAM,GAAGD,gBAAgB,mBAAmB,CAAC;QACzD;IACF,EAAE,OAAOE,GAAG;QACV,sEAAsE;QACtE,IAAI,AAACA,EAA4BC,IAAI,KAAK,UAAU;YAClDH,kBAAkBpB,KAAKC,mBAAmBe;QAC5C,OAAO;YACL,MAAMM;QACR;IACF;IAEA,MAAME,SAAShC,YAAY,GAAGiC,QAAQ,CAAC;IACvC,MAAMC,WAAW1B,KAAKmB,eAAe,CAAC,QAAQ,EAAEH,YAAY,CAAC,EAAEQ,QAAQ;IAEvE,sFAAsF;IACtF,MAAMG,WAAW;QAAC;QAAgB;QAAQ;KAAM;IAEhD,yCAAyC;IACzC,MAAMxB,kBAAkBiB,iBAAiBM,UAAUC;IAEnD,qDAAqD;IACrD,MAAM7B,QAAQE,KAAKoB,iBAAiB,iBAAiBpB,KAAK0B,UAAU;IAEpE,iDAAiD;IACjD,MAAME,kBAAkB5B,KAAK0B,UAAU;IACvC,MAAMG,cAAc,MAAMjC,SAASgC,iBAAiB;IACpD,MAAME,kBAAkBC,KAAKC,KAAK,CAACH;IACnCC,gBAAgBG,IAAI,GAAG,GAAGH,gBAAgBG,IAAI,CAAC,CAAC,EAAET,QAAQ;IAC1D,MAAMzB,UAAU6B,iBAAiBG,KAAKG,SAAS,CAACJ,iBAAiB,MAAM;IAEvE,OAAOJ;AACT"}