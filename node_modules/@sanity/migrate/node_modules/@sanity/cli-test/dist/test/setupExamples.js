import { exec as execNode } from 'node:child_process';
import { readFile, rm, writeFile } from 'node:fs/promises';
import { basename, join } from 'node:path';
import { promisify } from 'node:util';
import ora from 'ora';
import { glob } from 'tinyglobby';
import { fileExists } from '../utils/fileExists.js';
import { getExamplesPath, getTempPath } from '../utils/paths.js';
import { DEFAULT_EXAMPLES } from './constants.js';
import { testCopyDirectory } from './testExample.js';
const exec = promisify(execNode);
async function getAdditionalExamplePaths(examples) {
    const paths = await glob(examples, {
        absolute: true,
        ignore: [
            '**/node_modules/**',
            '**/dist/**'
        ],
        onlyDirectories: true
    });
    const additionalExamples = [];
    for (const path of paths){
        if (await fileExists(join(`${path}/package.json`))) {
            additionalExamples.push({
                example: basename(path),
                fromPath: path
            });
        }
    }
    return additionalExamples;
}
/**
 * Global setup function for initializing test examples.
 *
 * Copies examples from the bundled location to a temp directory
 * and installs dependencies.
 *
 * Note: Examples are NOT built during setup. Tests that need built
 * examples should build them as part of the test.
 *
 * This function is designed to be used with vitest globalSetup.
 *
 * @param options - Configuration options
 * @example
 * ```typescript
 * // In vitest.config.ts
 * export default defineConfig({
 *   test: {
 *     globalSetup: ['@sanity/cli-test/vitest']
 *   }
 * })
 * ```
 */ export async function setup(_, options = {}) {
    const { additionalExamples, tempDir } = options;
    const spinner = ora({
        // Without this, the watch mode input is discarded
        discardStdin: false,
        text: 'Initializing test environment...'
    }).start();
    try {
        const examplesDir = getExamplesPath();
        const tempDirectory = getTempPath(tempDir);
        const allExamplePaths = [];
        // Add the default examples
        for (const example of DEFAULT_EXAMPLES){
            allExamplePaths.push({
                example,
                fromPath: join(examplesDir, example)
            });
        }
        // Add the additional examples
        if (additionalExamples && additionalExamples.length > 0) {
            const additionalExamplePaths = await getAdditionalExamplePaths(additionalExamples);
            if (additionalExamplePaths.length > 0) {
                allExamplePaths.push(...additionalExamplePaths);
            } else {
                spinner.warn(`No additional examples found, check the glob pattern: ${additionalExamples.join(', ')}`);
            }
        }
        for (const { example, fromPath } of allExamplePaths){
            const toPath = join(tempDirectory, `example-${example}`);
            // Copy the example, excluding node_modules and dist
            await testCopyDirectory(fromPath, toPath, [
                'node_modules',
                'dist'
            ]);
            // Replace the package.json name with a temp name
            const packageJsonPath = join(toPath, 'package.json');
            const packageJson = await readFile(packageJsonPath, 'utf8');
            const packageJsonData = JSON.parse(packageJson);
            packageJsonData.name = `${packageJsonData.name}-test`;
            await writeFile(packageJsonPath, JSON.stringify(packageJsonData, null, 2));
            // Run pnpm install --no-lockfile in the temp directory
            try {
                await exec(`pnpm install --prefer-offline --no-lockfile`, {
                    cwd: toPath
                });
            } catch (error) {
                const execError = error;
                spinner.fail('Failed to install dependencies');
                console.error(execError.stderr || execError.stdout || execError.message);
                throw new Error(`Error installing dependencies in ${toPath}: ${execError.stderr || execError.stdout || execError.message}`);
            }
        }
        spinner.succeed('Test environment initialized');
    } catch (error) {
        spinner.fail('Failed to initialize test environment');
        throw error;
    }
}
/**
 * Teardown function to clean up test examples.
 *
 * Removes the temp directory created by setupTestExamples.
 *
 * This function is designed to be used with vitest globalSetup.
 *
 * @param options - Configuration options
 */ export async function teardown(options = {}) {
    const { tempDir } = options;
    const tempDirectory = getTempPath(tempDir);
    // Remove the tmp directory
    await rm(tempDirectory, {
        force: true,
        recursive: true
    });
}

//# sourceMappingURL=setupExamples.js.map