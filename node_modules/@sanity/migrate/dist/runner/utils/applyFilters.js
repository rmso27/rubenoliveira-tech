import { evaluate, parse } from 'groq-js';
function isSystemDocumentId(id) {
    return id.startsWith('_.');
}
function parseGroqFilter(filter) {
    try {
        return parse(`*[${filter}]`);
    }
    catch (err) {
        if (err instanceof Error) {
            err.message = `Failed to parse GROQ filter "${filter}": ${err.message}`;
            throw err;
        }
        throw new Error(`Failed to parse GROQ filter "${filter}": ${String(err)}`);
    }
}
export async function matchesFilter(parsedFilter, document) {
    const result = await (await evaluate(parsedFilter, { dataset: [document] })).get();
    return result.length === 1;
}
export async function* applyFilters(migration, documents) {
    const documentTypes = migration.documentTypes;
    const parsedFilter = migration.filter ? parseGroqFilter(migration.filter) : undefined;
    for await (const doc of documents) {
        if (isSystemDocumentId(doc._id)) {
            continue;
        }
        if (documentTypes && documentTypes.length > 0 && !documentTypes.includes(doc._type)) {
            continue;
        }
        if (parsedFilter && !(await matchesFilter(parsedFilter, doc))) {
            continue;
        }
        yield doc;
    }
}
//# sourceMappingURL=applyFilters.js.map